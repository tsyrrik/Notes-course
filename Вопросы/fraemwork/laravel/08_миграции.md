## Вопрос: Миграции и Schema Builder
Версия: Laravel 12.x (актуальная), 11.x в security-fixes; PHP 8.2–8.4.

## Простой ответ
Миграции — версия схемы БД в коде: создаём/меняем таблицы через PHP, чтобы команда и CI применяли одинаковую структуру.

## Ответ

Миграции — это система версионного контроля схемы базы данных. Каждая миграция — это PHP-класс, который описывает изменение структуры БД (создание/изменение таблиц, индексов, внешних ключей). Миграции хранятся в `database/migrations/` и выполняются последовательно по временной метке в имени файла. Это гарантирует, что все разработчики и серверы (dev, staging, production) имеют одинаковую структуру базы данных.

**Как работают миграции:** Laravel ведёт таблицу `migrations`, в которой записывает, какие миграции уже были выполнены. При вызове `php artisan migrate` выполняются только новые (ещё не выполненные) миграции. Метод `up()` применяет изменение, метод `down()` — откатывает его.

```bash
# Создание миграции
php artisan make:migration create_users_table            # создание таблицы
php artisan make:migration add_phone_to_users_table      # изменение таблицы
php artisan make:migration create_orders_table --create=orders  # с шаблоном create

# Выполнение миграций
php artisan migrate                   # выполнить все новые миграции
php artisan migrate --seed            # + запустить сидеры
php artisan migrate:rollback          # откатить последний batch
php artisan migrate:rollback --step=3 # откатить 3 последних миграции
php artisan migrate:reset             # откатить все миграции
php artisan migrate:refresh           # rollback + migrate (пересоздание)
php artisan migrate:fresh             # drop all tables + migrate (с нуля)
php artisan migrate:status            # показать статус миграций
```

**Schema Builder — основные типы колонок:**

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration  // Анонимные классы (Laravel 9+, рекомендуется)
{
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            // Первичные ключи
            $table->id();                           // BIGINT UNSIGNED AUTO_INCREMENT
            $table->uuid('id')->primary();          // UUID как первичный ключ

            // Строки
            $table->string('name', 100);            // VARCHAR(100)
            $table->string('email')->unique();      // с уникальным индексом
            $table->text('bio')->nullable();         // TEXT, может быть NULL
            $table->longText('content');             // LONGTEXT

            // Числа
            $table->integer('age');
            $table->unsignedBigInteger('views')->default(0);
            $table->decimal('price', 10, 2);        // DECIMAL(10,2)
            $table->float('rating', 3, 1);

            // Дата/время
            $table->timestamp('email_verified_at')->nullable();
            $table->date('birth_date');
            $table->timestamps();                   // created_at + updated_at
            $table->softDeletes();                  // deleted_at для soft deletes

            // Boolean, JSON, Enum
            $table->boolean('active')->default(true);
            $table->json('settings')->nullable();
            $table->enum('status', ['draft', 'published', 'archived']);

            // Foreign keys
            $table->foreignId('user_id')->constrained()->cascadeOnDelete();
            $table->foreignId('category_id')->nullable()->constrained()->nullOnDelete();

            // Индексы
            $table->index('name');                   // обычный индекс
            $table->unique(['email', 'tenant_id']);  // составной уникальный индекс
            $table->fullText('content');             // полнотекстовый индекс (MySQL)
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('users');
    }
};
```

**Модификаторы колонок:**

```php
$table->string('name')->nullable();          // может быть NULL
$table->integer('order')->default(0);        // значение по умолчанию
$table->string('phone')->after('email');     // позиция после поля (MySQL)
$table->string('note')->comment('Заметка'); // комментарий к полю
$table->string('old_field')->change();       // изменить существующее поле
```

**Squashing миграций** (Laravel 11) — когда миграций становится слишком много, можно объединить их в SQL-дамп:

```bash
php artisan schema:dump
php artisan schema:dump --prune  # + удалить старые файлы миграций
```

**Практический совет:** всегда пишите метод `down()` — это позволяет откатывать миграции в development и на staging. Никогда не редактируйте уже выполненные миграции — создавайте новые. Используйте `foreignId()->constrained()` вместо ручного создания внешних ключей — это лаконичнее. Перед деплоем на production проверяйте миграции локально через `migrate:fresh --seed`.

## Примеры

1. `php artisan make:migration create_posts_table`.
2. `Schema::create('posts', function (Blueprint $t) { ... })`.
3. Откат: `php artisan migrate:rollback`.

## Доп. теория

1. Не редактируйте применённые миграции.
2. Миграции позволяют воспроизводить схему в CI/CD.
