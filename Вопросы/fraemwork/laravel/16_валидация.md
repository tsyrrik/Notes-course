## Вопрос: Валидация
Версия: Laravel 12.x (актуальная), 11.x в security-fixes; PHP 8.2–8.4.

## Простой ответ
Валидация проверяет входящие данные по правилам (required/email/min и т.п.).

## Ответ

Валидация в Laravel — это механизм проверки входящих данных на соответствие набору правил. Если данные не прошли валидацию, Laravel автоматически перенаправляет пользователя назад с ошибками (для веб-запросов) или возвращает JSON-ответ с кодом 422 (для API-запросов). Валидация — первый рубеж защиты приложения от некорректных или вредоносных данных.

**Способ 1: Валидация в контроллере через `$request->validate()`:**

```php
public function store(Request $request)
{
    $validated = $request->validate([
        'name'     => 'required|string|max:255',
        'email'    => 'required|email|unique:users,email',
        'password' => 'required|min:8|confirmed',  // ожидает поле password_confirmation
        'age'      => 'required|integer|min:18|max:120',
        'avatar'   => 'nullable|image|mimes:jpg,png|max:2048', // макс 2MB
        'tags'     => 'nullable|array',
        'tags.*'   => 'string|max:50',             // каждый элемент массива
    ]);

    // $validated содержит ТОЛЬКО валидные поля
    User::create($validated);
}
```

**Способ 2: Через фасад Validator (больше контроля):**

```php
use Illuminate\Support\Facades\Validator;

public function store(Request $request)
{
    $validator = Validator::make($request->all(), [
        'name'  => 'required|string|max:255',
        'email' => 'required|email|unique:users',
    ]);

    // Кастомная логика при ошибке
    if ($validator->fails()) {
        return redirect()->back()
            ->withErrors($validator)
            ->withInput();
    }

    // Доступ к ошибкам
    $errors = $validator->errors();
    $errors->first('email');     // первая ошибка поля
    $errors->all();              // все ошибки списком

    // Добавить ошибку вручную (after hook)
    $validator->after(function ($validator) {
        if ($this->somethingElseIsInvalid()) {
            $validator->errors()->add('field', 'Something is wrong!');
        }
    });

    $validated = $validator->validated();
}
```

**Кастомные сообщения об ошибках:**

```php
$request->validate(
    // Правила
    [
        'name'  => 'required|string|max:255',
        'email' => 'required|email|unique:users',
        'phone' => 'required|regex:/^\+7\d{10}$/',
    ],
    // Кастомные сообщения
    [
        'name.required'  => 'Укажите имя пользователя',
        'email.unique'   => 'Этот email уже зарегистрирован',
        'phone.regex'    => 'Формат телефона: +7XXXXXXXXXX',
    ],
    // Кастомные имена атрибутов
    [
        'name'  => 'имя',
        'email' => 'электронная почта',
    ]
);
```

**Часто используемые правила валидации:**

```php
$rules = [
    // Строки
    'name'     => 'required|string|min:2|max:255',
    'slug'     => 'required|alpha_dash',           // буквы, цифры, - и _
    'url'      => 'required|url',
    'ip'       => 'required|ip',

    // Числа
    'price'    => 'required|numeric|min:0',
    'quantity' => 'required|integer|between:1,100',

    // Даты
    'start'    => 'required|date|after:today',
    'end'      => 'required|date|after:start',

    // Файлы
    'document' => 'required|file|mimes:pdf,docx|max:10240', // 10MB
    'photo'    => 'required|image|dimensions:min_width=100,min_height=100',

    // Условные правила
    'email'    => 'required_if:contact_type,email',
    'phone'    => 'required_unless:contact_type,email',
    'company'  => 'required_with:position',         // обязателен если есть position
    'nickname' => 'required_without:name',           // обязателен если нет name
    'note'     => 'exclude_if:type,private',         // исключить из validated()

    // БД
    'email'    => 'unique:users,email',
    'role_id'  => 'exists:roles,id',
    'status'   => Rule::in(['active', 'inactive', 'banned']),

    // Пароль (Laravel 11)
    'password' => ['required', 'confirmed', Password::min(8)->mixedCase()->numbers()->symbols()],
];
```

**Отображение ошибок в Blade:**

```blade
{{-- Все ошибки --}}
@if ($errors->any())
    <div class="alert alert-danger">
        <ul>
            @foreach ($errors->all() as $error)
                <li>{{ $error }}</li>
            @endforeach
        </ul>
    </div>
@endif

{{-- Ошибка конкретного поля --}}
<input type="text" name="email" value="{{ old('email') }}"
       class="@error('email') is-invalid @enderror">
@error('email')
    <span class="invalid-feedback">{{ $message }}</span>
@enderror
```

**Практический совет:** для сложных форм выносите правила в Form Request (см. следующий вопрос). Используйте `$request->validated()` вместо `$request->all()` — это возвращает только те поля, которые прошли валидацию, защищая от mass assignment. Правило `Password::defaults()` позволяет задать стандартные требования к паролю в `AppServiceProvider` и использовать их везде. Массивы валидируются через точечную нотацию: `'items.*.price' => 'required|numeric'`.

## Примеры

1. `$request->validate(['email' => 'required|email'])`.
2. `Validator::make($data, $rules)`.
3. Кастомные сообщения: `['email.required' => '...']`.

## Доп. теория

1. Ошибки валидации возвращаются в сессию и доступны в Blade.
2. Можно создавать кастомные правила и сообщения.
