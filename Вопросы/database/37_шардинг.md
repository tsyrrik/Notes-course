# Шардирование (Sharding)

Простыми словами: разбиваем данные на секции/шарды и раскладываем по разным серверам, чтобы масштабировать объём и чтение/запись. Это частный случай партиционирования.

## Зачем
- Горизонтально масштабировать данные и нагрузку.
- Сократить объём на одном узле, снизить I/O и размер индексов.
- Разнести «горячие» нагрузки по нескольким нодам.

## Ключ шардирования
- Определяет, куда кладём и где ищем строку. Хороший ключ — единица шардирования (user_id/tenant_id и т.п.).  
- Цель: частые запросы затрагивают минимум шардов.

## Способы распределения
- Фиксированное: хеш/деление по модулю → bucket → shard. Просто, но сложно менять конфиг (ревизия хеша = перетасовка данных).
- Динамическое (таблица сопоставления key→shard или виртуальные bucket’ы): гибко переносить/балансировать, но нужен каталог/координатор, кэш карты.
- Комбинированное: key→virtual bucket (хеш), bucket→shard (config).

## Поиск данных
- Умный клиент: знает карту bucket→shard.
- Прокси: принимает запросы как к одной БД, сам роутит (минус — удвоение трафика, точка отказа, но можно слить с LB/failover).
- Координатор: быстро отвечает «куда идти», клиент дальше напрямую к ноде.

## Перемещение данных (решардинг)
- Перебалансировка bucket’ов/таблицы сопоставления; старайтесь не тасовать часто.
- Приём “update is a move”/data expiration: новые данные льются в новые ноды, старые истекают.

## Выбор схемы
- Статичный хеш/модуль — просто, но больно при расширении.
- Виртуальные bucket’ы + карта — гибче: добавление нод = смена назначений bucket’ов, перенос части данных.

## Консистентное хеширование (коротко)
- Ключи/узлы отображаются на кольцо; при добавлении/потере узла перераспределяется лишь его диапазон.
- Часто используют виртуальные ноды для равномерности и контроля веса.

## Шардирование vs партиционирование
- Партиционирование — делим таблицу внутри одной БД/кластера.
- Шардирование — распределяем логические части по разным физическим узлам.

## Подводные камни
- Межшардовые запросы (JOIN/агрегации) дороже.
- Миграции/схема: нужно синхронизировать на всех шардах.
- Балансировка «горячих» ключей: плохой ключ даёт перекос нагрузки. 
