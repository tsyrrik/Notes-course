## Вопрос: Copy-on-Write (COW)
Версия: PHP 8.4; где есть исторические детали — см. по тексту.

## Простой ответ
присваиваем массив/строку — копии нет; копирование происходит только в момент изменения одной из ссылок.

## Ответ

Copy-on-Write (COW) — внутренняя оптимизация движка PHP (Zend Engine), при которой данные физически копируются только в момент изменения, а не при присваивании.

### Как работает

Каждое значение хранится в структуре `zval`, у которой есть счётчик ссылок (`refcount`). При присваивании `$b = $a`:
1. Новый zval **не создаётся** — `$b` указывает на тот же zval, что и `$a`.
2. `refcount` увеличивается на 1.
3. Когда одна из переменных **изменяется**, PHP проверяет `refcount > 1` → создаёт копию (separation) и модифицирует только её.

### Где применяется

- Передача массивов/строк в функции — копия создаётся только если функция их меняет.
- Присваивание переменных.
- Передача значений между итерациями цикла.

### Что ломает COW

- Оператор ссылки `&` — PHP помечает zval как `is_ref`, и COW перестаёт работать.
- `debug_zval_refcount()` — показывает текущий refcount (для отладки).

### Практическое значение

- **Не нужно** передавать массивы по ссылке «для скорости» — COW уже это оптимизирует.
- **Строки** тоже используют COW — даже длинные строки не копируются при присваивании.
- **Объекты** передаются по handle (идентификатору) — COW для них не применяется, т.к. переменная содержит handle, а не сам объект.

## Примеры

```php
$a = [1, 2, 3];
$b = $a;   // копии данных нет, refcount = 2
$b[] = 4;  // теперь создаётся копия для $b, у $a refcount = 1

// Передача в функцию — тоже COW
function sum(array $arr): int { // копия не создаётся
    return array_sum($arr);
}
sum($a); // $a не копируется, т.к. функция не модифицирует массив

// Ссылка ломает COW
$c = &$a; // теперь $a и $c связаны ссылкой, COW отключен
$d = $a;  // здесь PHP вынужден скопировать данные
```

## Доп. теория
- COW работает для **массивов и строк**; для объектов используется handle, а физическая копия создаётся только при `clone`.
- Механизм separation может срабатывать в неожиданных местах (например, при `foreach` по ссылке).
