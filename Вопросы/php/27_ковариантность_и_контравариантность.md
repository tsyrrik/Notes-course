## Вопрос: Ковариантность и контравариантность
Версия: PHP 8.4; где есть исторические детали — см. по тексту.

## Простой ответ
- Ковариантность: возвращаем более конкретный тип; контравариантность: принимаем более общий тип аргумента.

## Ответ

Ковариантность и контравариантность — правила изменения типов при наследовании, основанные на принципе подстановки Лисков (LSP). PHP поддерживает их с версии 7.4.

### Ковариантность (возвращаемые типы)

Наследник может **сузить** (уточнить) возвращаемый тип — вернуть **более конкретный** тип:

```
Родитель: Animal    →    Наследник: Dog (сужение — OK)
Родитель: Dog       →    Наследник: Animal (расширение — ОШИБКА)
```

```php
class Animal {}
class Dog extends Animal {}

class Factory {
    public function create(): Animal { return new Animal(); }
}

class DogFactory extends Factory {
    public function create(): Dog { return new Dog(); } // OK — Dog является Animal
}
```

**Почему это безопасно**: код, ожидающий `Animal`, получит `Dog` — который является `Animal`. Контракт не нарушен.

### Контравариантность (аргументы)

Наследник может **расширить** (обобщить) тип аргумента — принять **более общий** тип:

```
Родитель: Dog       →    Наследник: Animal (расширение — OK)
Родитель: Animal    →    Наследник: Dog (сужение — ОШИБКА)
```

```php
class Trainer {
    public function train(Dog $dog): void {}
}

class MasterTrainer extends Trainer {
    public function train(Animal $animal): void {} // OK — принимает больше
}
```

**Почему это безопасно**: код передаёт `Dog`, а `MasterTrainer` принимает любой `Animal` (включая `Dog`). Контракт не нарушен.

### Запрещённые изменения

```php
// ОШИБКА: расширение возвращаемого типа
class BadFactory extends DogFactory {
    public function create(): Animal {} // Fatal error
}

// ОШИБКА: сужение аргумента
class BadTrainer extends Trainer {
    public function train(Poodle $poodle): void {} // Fatal error
}
```

### Мнемоника

| | Возвращаемый тип | Тип аргумента |
| --- | --- | --- |
| Можно | Сузить (конкретнее) | Расширить (общее) |
| Нельзя | Расширить | Сузить |

> Запомнить: **возвращаем конкретнее, принимаем шире** — PECS (Producer Extends, Consumer Super) из Java.

## Примеры

```php
interface Repository {
    public function find(int|string $id): ?Entity;
    public function save(Entity $entity): Entity;
}

class UserRepository implements Repository {
    // Ковариантность: возвращаем User (уже Entity)
    public function find(int|string $id): ?User { /* ... */ }

    // Ковариантность: возвращаем User (уже Entity)
    public function save(Entity $entity): User { /* ... */ }
}
```

## Доп. теория
- PHP поддерживает ковариантность/контравариантность с версии 7.4.
- Сужение аргументов или расширение возвращаемого типа нарушает LSP и приводит к фатальной ошибке.
