**Deadlock** ‚Äî —ç—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ **–¥–≤–µ (–∏–ª–∏ –±–æ–ª–µ–µ) —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∂–¥—É—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞**,  
–∏ –Ω–∏ –æ–¥–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

> –ö–∞–∂–¥–∞—è –¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É, –Ω—É–∂–Ω—É—é –¥—Ä—É–≥–æ–π,  
> –∏ –Ω–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å —à–∞–≥ –≤–ø–µ—Ä—ë–¥.

---

### 1. –ü—Ä–∏–º–µ—Ä –≤ –¥–≤—É—Ö —Å—Ç—Ä–æ–∫–∞—Ö

```sql
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è A
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è B
BEGIN;
UPDATE accounts SET balance = balance - 50 WHERE id = 2;

-- –¢–µ–ø–µ—Ä—å –æ–±–µ –ø—ã—Ç–∞—é—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ –∂–µ —Å—Ç—Ä–æ–∫–∏, –Ω–æ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
-- A:
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

-- B:
UPDATE accounts SET balance = balance + 50 WHERE id = 1;
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:

```
ERROR: deadlock detected
DETAIL: Process 1234 waits for ShareLock on transaction 5678; blocked by process 5679.
```

> –û–±–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–µ—Ä–∂–∞—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∏ –∂–¥—É—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞.  
> PostgreSQL –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —ç—Ç–æ—Ç —Ü–∏–∫–ª –∏ **—É–±–∏–≤–∞–µ—Ç –æ–¥–Ω—É –∏–∑ –Ω–∏—Ö**, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–Ω—É—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞.

---

### 2. –ö–∞–∫ PostgreSQL —ç—Ç–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç

PostgreSQL –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç **–≥—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**.  
–ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è —Ü–∏–∫–ª –≤–∏–¥–∞:

```
A ‚Üí –∂–¥—ë—Ç B
B ‚Üí –∂–¥—ë—Ç A
```

‚Äî –±–∞–∑–∞ –≤—ã–∑—ã–≤–∞–µ—Ç ‚Äú–∂–µ—Ä—Ç–≤—É‚Äù (rollback –æ–¥–Ω–æ–π –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π).

–°–æ–æ–±—â–µ–Ω–∏–µ:

```
ERROR:  deadlock detected
HINT:  See server log for query details.
```

---

### 3. –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã deadlock

|–ü—Ä–∏—á–∏–Ω–∞|–ü—Ä–∏–º–µ—Ä|
|---|---|
|üîÑ **–†–∞–∑–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫**|—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Ç–∞–±–ª–∏—Ü—ã –≤ —Ä–∞–∑–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏|
|üîí **SELECT ... FOR UPDATE**|—Ä–∞–∑–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–µ—Ä—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω—ã–µ –Ω–∞–±–æ—Ä—ã|
|üí¨ **–¢—Ä–∏–≥–≥–µ—Ä—ã / –∫–∞—Å–∫–∞–¥–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**|—Ç—Ä–∏–≥–≥–µ—Ä –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–æ, —á—Ç–æ —É–∂–µ –∑–∞–Ω—è—Ç–æ –¥—Ä—É–≥–æ–π|
|üß± **–ù–µ—Å–∫–æ–ª—å–∫–æ UPDATE –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**|–ø—Ä–∏ –¥–ª–∏–Ω–Ω—ã—Ö —Ü–µ–ø–æ—á–∫–∞—Ö –∑–∞–ø—Ä–æ—Å–æ–≤|
|üì¶ **–í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ / —Ñ—É–Ω–∫—Ü–∏–∏**|–æ—Å–æ–±–µ–Ω–Ω–æ —Å `plpgsql` –∏ `PERFORM`|

---

### 4. –ö–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ deadlock

```sql
-- –¢–µ—Ä–º–∏–Ω–∞–ª 1
BEGIN;
UPDATE users SET name='A' WHERE id=1;

-- –¢–µ—Ä–º–∏–Ω–∞–ª 2
BEGIN;
UPDATE users SET name='B' WHERE id=2;

-- –¢–µ—Ä–º–∏–Ω–∞–ª 1
UPDATE users SET name='A' WHERE id=2; -- –∂–¥—ë—Ç –≤—Ç–æ—Ä–æ–≥–æ

-- –¢–µ—Ä–º–∏–Ω–∞–ª 2
UPDATE users SET name='B' WHERE id=1; -- –≤–∑–∞–∏–º–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
```

PostgreSQL —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É:

```
ERROR:  deadlock detected
DETAIL:  Process 254 waits for ShareLock on transaction 256; blocked by process 256.
```

---

### 5. –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å deadlock

#### ‚úÖ 1. –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–π —Ç–∞–±–ª–∏—Ü—ã **–≤ –æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ**

```sql
-- –•–æ—Ä–æ—à–æ
UPDATE users SET ... WHERE id=1;
UPDATE users SET ... WHERE id=2;

-- –ü–ª–æ—Ö–æ
-- –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤ –ø–æ—Ä—è–¥–∫–µ (1,2), –¥—Ä—É–≥–∞—è (2,1)
```

#### ‚úÖ 2. –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

> –ß–µ–º –∫–æ—Ä–æ—á–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è ‚Äî —Ç–µ–º –º–µ–Ω—å—à–µ —à–∞–Ω—Å–æ–≤ –Ω–∞ –≤–∑–∞–∏–º–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.

#### ‚úÖ 3. –ò–∑–±–µ–≥–∞–π SELECT ... FOR UPDATE, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞—Ç—å ‚Äî –Ω–µ —Å—Ç–∞–≤—å —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É:

```sql
SELECT * FROM users WHERE id=1; -- –±–µ–∑ FOR UPDATE
```

#### ‚úÖ 4. –ò—Å–ø–æ–ª—å–∑—É–π —è–≤–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∏ batch-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö

```sql
UPDATE users SET ... WHERE id IN (1,2,3) ORDER BY id;
```

#### ‚úÖ 5. –ü–æ–≤—Ç–æ—Ä—è–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ

Deadlock –Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å,  
–ø–æ—ç—Ç–æ–º—É –∫–æ–¥ –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å **–ø–æ–≤—Ç–æ—Ä—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é** –ø—Ä–∏ –æ—à–∏–±–∫–µ `40P01`:

```php
try {
    $pdo->beginTransaction();
    // ... SQL ...
    $pdo->commit();
} catch (PDOException $e) {
    if ($e->getCode() === '40P01') {
        // retry logic
    }
}
```

---

### 6. –ö–∞–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:

```sql
SELECT
    pid,
    blocked_locks.relation::regclass AS locked_table,
    blocked_activity.usename AS user,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity
  ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
  ON blocking_locks.locktype = blocked_locks.locktype
  AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
  AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
  AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity
  ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

> –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–∫–∞–∂–µ—Ç, –∫—Ç–æ –∫–æ–≥–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç, –Ω–∞ –∫–∞–∫–æ–π —Ç–∞–±–ª–∏—Ü–µ –∏ –∫–∞–∫–∏–º SQL.

---

### 7. Deadlock vs Lock contention

|–¢–µ—Ä–º–∏–Ω|–ß—Ç–æ —ç—Ç–æ|
|---|---|
|**Lock contention**|–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –∑–∞ –æ–¥–Ω—É –∏ —Ç—É –∂–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (–∫—Ç–æ-—Ç–æ –∂–¥—ë—Ç, –Ω–æ –ø–æ—Ç–æ–º –ø–æ–ª—É—á–∞–µ—Ç)|
|**Deadlock**|—Ü–∏–∫–ª –æ–∂–∏–¥–∞–Ω–∏—è, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã–π—Ç–∏ –Ω–µ–ª—å–∑—è (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ rollback)|

> Lock contention ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–¥–µ—Ä–∂–∫–∞,  
> deadlock ‚Äî —Ç—É–ø–∏–∫.

---

### 8. –°–≤—è–∑—å —Å —É—Ä–æ–≤–Ω–µ–º –∏–∑–æ–ª—è—Ü–∏–∏

–ù–∞ —É—Ä–æ–≤–Ω—è—Ö –∏–∑–æ–ª—è—Ü–∏–∏ `READ COMMITTED` –∏ –≤—ã—à–µ PostgreSQL —Å—Ç–∞–≤–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫ –ø—Ä–∏ `UPDATE/DELETE`.  
–ù–∞ `SERIALIZABLE` –º–æ–∂–µ—Ç –±—ã—Ç—å **–ª–æ–≥–∏—á–µ—Å–∫–∏–π deadlock** ‚Äî  
PostgreSQL –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å.

---

### üí° –í –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–µ

> **Deadlock** ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –¥–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–µ–∂–ª–∏–≤–æ –∂–¥—É—Ç,  
> –ø–æ–∫–∞ –¥—Ä—É–≥–∞—è –æ—Å–≤–æ–±–æ–¥–∏—Ç —Ä–µ—Å—É—Ä—Å‚Ä¶  
> –∏ –Ω–∏–∫—Ç–æ —Ç–∞–∫ –∏ –Ω–µ –¥–æ–∂–¥–∞–ª—Å—è.  
> PostgreSQL —Ä–µ—à–∞–µ—Ç —Å–ø–æ—Ä –ø—Ä–æ—Å—Ç–æ ‚Äî **—É–±–∏–≤–∞–µ—Ç –æ–¥–Ω–æ–≥–æ**.