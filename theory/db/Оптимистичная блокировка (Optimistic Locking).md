**–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞** ‚Äî —ç—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º,  
–ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π —Å–∏—Å—Ç–µ–º–∞ **–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å –∑–∞—Ä–∞–Ω–µ–µ**,  
–∞ –ø—Ä–æ—Å—Ç–æ **–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º**, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∫—Ç–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª.

> –ò–¥–µ—è: ‚Äú—è –≤–µ—Ä—é, —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–µ —Ç—Ä–æ–Ω–µ—Ç –∑–∞–ø–∏—Å—å, –ø–æ–∫–∞ —è —Å –Ω–µ–π —Ä–∞–±–æ—Ç–∞—é.  
> –ê –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ —Ç—Ä–æ–Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ–±—É—é —Å–Ω–æ–≤–∞.‚Äù

---

### 1. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

|–ü–æ–¥—Ö–æ–¥|–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç|–ü—Ä–∏–º–µ—Ä|
|---|---|---|
|**–ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–π (pessimistic)**|—Å—Ç–∞–≤–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Å—Ä–∞–∑—É (`SELECT ... FOR UPDATE`)|–±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ –∑–∞–º–µ–¥–ª—è–µ—Ç|
|**–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π (optimistic)**|–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º|–±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã|

> –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–∞–º, –≥–¥–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã **—Ä–µ–¥–∫–∏**,  
> –∞ —Å–∫–æ—Ä–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ, —á–µ–º –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å.

---

### 2. –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ß–∏—Ç–∞–µ–º –æ–±—ä–µ–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
    
2. –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –µ–≥–æ ‚Äú–≤–µ—Ä—Å–∏—é‚Äù ‚Äî –Ω–æ–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ timestamp.
    
3. –ò–∑–º–µ–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ.
    
4. –ü–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º ‚Äî —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º, –Ω–µ –ø–æ–º–µ–Ω—è–ª–∞—Å—å –ª–∏ –≤–µ—Ä—Å–∏—è.
    
5. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Äî –∫—Ç–æ-—Ç–æ –æ–±–Ω–æ–≤–∏–ª –∑–∞–ø–∏—Å—å —Ä–∞–Ω—å—à–µ ‚Üí –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é.
    

---

### 3. –ü—Ä–∏–º–µ—Ä –≤ SQL

#### –¢–∞–±–ª–∏—Ü–∞

```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    name TEXT,
    balance INT,
    version INT DEFAULT 0
);
```

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```sql
UPDATE users
SET balance = balance + 10, version = version + 1
WHERE id = 1 AND version = 5;
```

–ï—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ —Ç—Ä–æ–≥–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤–µ—Ä—Å–∏–∏ 5 ‚Üí –æ–±–Ω–æ–≤–∏—Ç—Å—è 1 —Å—Ç—Ä–æ–∫–∞.  
–ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Üí –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—ë—Ç `0 rows affected`,  
–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É.

---

### 4. –ü—Ä–∏–º–µ—Ä –≤ PHP / Doctrine

Doctrine ORM –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É ‚Äú–∏–∑ –∫–æ—Ä–æ–±–∫–∏‚Äù:

```php
/**
 * @Entity
 * @OptimisticLocking(type="version", versionField="version")
 */
class User
{
    /** @Version @Column(type="integer") */
    private $version;
}
```

–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ —É—Å–ø–µ–ª –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å,  
–ø—Ä–∏ `flush()` ORM –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `OptimisticLockException`.

---

### 5. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

|–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è|–ó–∞—á–µ–º|
|---|---|
|üßæ **REST API / GraphQL**|–ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ|
|üì¶ **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**|–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–∞–Ω—Å|
|üí¨ **–§–æ—Ä–º—ã –∏ UI**|–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥—Ä—É–≥–æ–≥–æ|
|üß† **DDD aggregate roots**|–¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö|

---

### 6. –ü—Ä–∏–º–µ—Ä –≤ API

–ó–∞–ø—Ä–æ—Å `PUT /users/1` –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:

```http
If-Match: "version=5"
```

–ê —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

```sql
UPDATE users
SET name = 'Alice', version = version + 1
WHERE id = 1 AND version = 5;
```

–ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚Üí HTTP 409 Conflict.  
–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å.

---

### 7. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

|‚úÖ –ü–ª—é—Å—ã|‚ùå –ú–∏–Ω—É—Å—ã|
|---|---|
|–ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ ‚Üí –≤—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å|–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤–æ–∑–º–æ–∂–Ω—ã|
|–ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞|–ù—É–∂–µ–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π ‚Äúversion‚Äù —Å—Ç–æ–ª–±–µ—Ü|
|–û—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è API|–¢—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ|
|–•–æ—Ä–æ—à–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è|–ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–∞ –≥–æ—Ä—è—á–∏—Ö –∑–∞–ø–∏—Å—è—Ö|

---

### 8. –û—Ç–ª–∏—á–∏–µ –æ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ deadlock‚Äô–æ–≤

- –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ **–Ω–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç** –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—é,  
    –æ–Ω–∞ –ø—Ä–æ—Å—Ç–æ **—Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç** –µ—ë –∏ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É.
    
- –≠—Ç–æ **–º–µ—Ö–∞–Ω–∏–∑–º —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è**, –∞ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.
    
- –ü–æ—ç—Ç–æ–º—É deadlock –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω ‚Äî –Ω–∏–∫—Ç–æ –Ω–∏–∫–æ–≥–æ –Ω–µ –∂–¥—ë—Ç.
    

---

### üí° –í –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–µ

> **–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞** ‚Äî —ç—Ç–æ –≤–µ—Ä–∞ –≤ –¥–æ–±—Ä–æ.  
> –ù–∏–∫—Ç–æ –Ω–µ —Ç—Ä–æ–Ω–µ—Ç —Ç–≤–æ—é –∑–∞–ø–∏—Å—å‚Ä¶  
> –ø–æ–∫–∞ –Ω–µ —Ç—Ä–æ–Ω–µ—Ç ‚Äî –∏ —Ç–æ–≥–¥–∞ —Ç—ã –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω—ë—à—å –∑–∞–Ω–æ–≤–æ.