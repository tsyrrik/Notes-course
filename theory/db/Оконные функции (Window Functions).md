**–û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** –ø–æ–∑–≤–æ–ª—è—é—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–æ ‚Äú–æ–∫–Ω—É‚Äù —Å—Ç—Ä–æ–∫ ‚Äî  
–º–Ω–æ–∂–µ—Å—Ç–≤—É –∑–∞–ø–∏—Å–µ–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ª–æ–≥–∏—á–µ—Å–∫–∏ (–ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –¥–∞—Ç–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç.–ø.),  
–Ω–æ –ø—Ä–∏ —ç—Ç–æ–º **–Ω–µ –æ–±—ä–µ–¥–∏–Ω—è—è –∏—Ö** –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, –∫–∞–∫ `GROUP BY`.  
–≠—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ PostgreSQL, ClickHouse, MySQL, SQL Server –∏ –¥—Ä—É–≥–∏—Ö –°–£–ë–î.

---

### 1. –°–∏–Ω—Ç–∞–∫—Å–∏—Å

```sql
<function>() OVER (
  [PARTITION BY ...]
  [ORDER BY ...]
  [ROWS|RANGE BETWEEN ...]
)
```

|–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|`PARTITION BY`|–†–∞–∑–¥–µ–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≥—Ä—É–ø–ø—ã (–æ–∫–Ω–∞)|
|`ORDER BY`|–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –≤–Ω—É—Ç—Ä–∏ –æ–∫–Ω–∞|
|`ROWS` / `RANGE`|–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤—Ö–æ–¥—è—Ç –≤ –æ–∫–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π|

---

### 2. –ü—Ä–∏–º–µ—Ä 1 ‚Äî –ö—É–º—É–ª—è—Ç–∏–≤–Ω–∞—è —Å—É–º–º–∞ (`SUM()`)

–¢–∞–±–ª–∏—Ü–∞ `payments`:

|user_id|created_at|amount|
|---|---|---|
|1|2024-01-01|100|
|1|2024-01-02|50|
|1|2024-01-03|30|
|2|2024-01-01|200|
|2|2024-01-02|10|

#### –ó–∞–ø—Ä–æ—Å

```sql
SELECT
  user_id,
  created_at,
  amount,
  SUM(amount) OVER (PARTITION BY user_id ORDER BY created_at) AS running_total
FROM payments;
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç

|user_id|created_at|amount|running_total|
|---|---|---|---|
|1|2024-01-01|100|100|
|1|2024-01-02|50|150|
|1|2024-01-03|30|180|
|2|2024-01-01|200|200|
|2|2024-01-02|10|210|

ü™ü –î–ª—è —Å—Ç—Ä–æ–∫–∏ `(1, 2024-01-03)` –æ–∫–Ω–æ –≤–∫–ª—é—á–∞–µ—Ç —Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏:  
`(100, 50, 30)` ‚Üí —Å—É–º–º–∞ = 180.  
–í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–∏–¥–Ω—ã ‚Äú–≤ –æ–∫–Ω–µ‚Äù.

---

### 3. –ü—Ä–∏–º–µ—Ä 2 ‚Äî –†–∞–∑–Ω–∏—Ü–∞ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–æ–∫–æ–π (`LAG()`)

```sql
SELECT
  user_id,
  created_at,
  amount,
  LAG(amount) OVER (PARTITION BY user_id ORDER BY created_at) AS prev_amount,
  amount - LAG(amount) OVER (PARTITION BY user_id ORDER BY created_at) AS diff
FROM payments;
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç

|user_id|created_at|amount|prev_amount|diff|
|---|---|---|---|---|
|1|2024-01-01|100|NULL|NULL|
|1|2024-01-02|50|100|-50|
|1|2024-01-03|30|50|-20|
|2|2024-01-01|200|NULL|NULL|
|2|2024-01-02|10|200|-190|

ü™ü –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äú–≤–∏–¥–∏—Ç‚Äù –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–æ–∫—É –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å–≤–æ–µ–≥–æ `user_id`.  
–ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `NULL`.

---

### 4. –ü—Ä–∏–º–µ—Ä 3 ‚Äî –†–µ–π—Ç–∏–Ω–≥ (`RANK()`)

–¢–∞–±–ª–∏—Ü–∞ `sales`:

|region|seller|revenue|
|---|---|---|
|north|Ivan|100|
|north|Olga|200|
|north|Alex|150|
|south|Dima|300|
|south|Oleg|250|

#### –ó–∞–ø—Ä–æ—Å

```sql
SELECT
  region,
  seller,
  revenue,
  RANK() OVER (PARTITION BY region ORDER BY revenue DESC) AS rank
FROM sales;
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç

|region|seller|revenue|rank|
|---|---|---|---|
|north|Olga|200|1|
|north|Alex|150|2|
|north|Ivan|100|3|
|south|Dima|300|1|
|south|Oleg|250|2|

ü™ü –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ–∫–Ω–æ —Å–≤–æ–µ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ (`PARTITION BY region`),  
–∏ –≤ –Ω—ë–º –ø–æ–ª—É—á–∞–µ—Ç –º–µ—Å—Ç–æ –ø–æ —É–±—ã–≤–∞–Ω–∏—é `revenue`.

---

### 5. –ü—Ä–∏–º–µ—Ä 4 ‚Äî –°–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ (`ROWS BETWEEN`)

–¢–∞–±–ª–∏—Ü–∞ `daily_sales`:

|date|sales|
|---|---|
|01-01|10|
|01-02|15|
|01-03|25|
|01-04|30|
|01-05|20|

#### –ó–∞–ø—Ä–æ—Å

```sql
SELECT
  date,
  sales,
  SUM(sales) OVER (
    ORDER BY date
    ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
  ) AS sales_last_3_days
FROM daily_sales;
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç

|date|sales|sales_last_3_days|
|---|---|---|
|01-01|10|10|
|01-02|15|25 (=10+15)|
|01-03|25|50 (=10+15+25)|
|01-04|30|70 (=15+25+30)|
|01-05|20|75 (=25+30+20)|

ü™ü –î–ª—è `01-05` –æ–∫–Ω–æ –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏: `01-03`, `01-04`, `01-05`.  
–≠—Ç–æ ‚Äú—Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ‚Äù –∏–∑ —Ç—Ä—ë—Ö –∑–∞–ø–∏—Å–µ–π.

---

### 6. –ü—Ä–∏–º–µ—Ä 5 ‚Äî –î–æ–ª—è –æ—Ç –æ–±—â–µ–≥–æ (`percent of total`)

```sql
SELECT
  region,
  revenue,
  revenue * 100.0 / SUM(revenue) OVER () AS percent_total
FROM sales;
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç

|region|revenue|percent_total|
|---|---|---|
|north|450|45%|
|south|550|55%|

ü™ü `OVER()` –±–µ–∑ `PARTITION` ‚Äî –∑–Ω–∞—á–∏—Ç, –æ–∫–Ω–æ = **–≤—Å—è —Ç–∞–±–ª–∏—Ü–∞**.

---

### 7. –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

|–§—É–Ω–∫—Ü–∏—è|–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ|
|---|---|
|`ROW_NUMBER()`|–ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏|
|`RANK()` / `DENSE_RANK()`|—Ä–µ–π—Ç–∏–Ω–≥ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏ / –±–µ–∑|
|`LAG()` / `LEAD()`|–¥–æ—Å—Ç—É–ø –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π / —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ|
|`FIRST_VALUE()` / `LAST_VALUE()`|–ø–µ—Ä–≤–æ–µ / –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ|
|`NTILE(n)`|–¥–µ–ª–∏—Ç –Ω–∞–±–æ—Ä –Ω–∞ n —á–∞—Å—Ç–µ–π|
|`SUM()` / `AVG()` / `COUNT()`|–∞–≥—Ä–µ–≥–∞—Ç—ã –≤ –æ–∫–Ω–µ|

---

### 8. –û—Ç–ª–∏—á–∏–µ –æ—Ç `GROUP BY`

|–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å|GROUP BY|–û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏|
|---|---|---|
|–ö–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫|–£–º–µ–Ω—å—à–∞–µ—Ç—Å—è|–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è|
|–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ|–ò—Ç–æ–≥–æ–≤—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã|–ê–Ω–∞–ª–∏—Ç–∏–∫–∞, –¥–∏–Ω–∞–º–∏–∫–∞, —Ä–∞–Ω–≥–∏|
|–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—è –±–µ–∑ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤|–ù–µ—Ç|–î–∞|
|–ü—Ä–∏–º–µ—Ä|`SUM()` –ø–æ –≥—Ä—É–ø–ø–µ|`SUM()` –ø–æ –æ–∫–Ω—É, –ø—Ä–∏ —ç—Ç–æ–º –≤–∏–¥–∏–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É|

---

### 9. –ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º

PostgreSQL –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:

- —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ `PARTITION` –∏ `ORDER BY`;
    
- —Å–æ–∑–¥–∞—ë—Ç "–æ–∫–Ω–æ" —Å —É–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ –Ω–∞ —Å—Ç—Ä–æ–∫–∏;
    
- –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∞–≥—Ä–µ–≥–∞—Ç—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–∫–Ω–∞.
    

–≠—Ç–æ –¥–∞—ë—Ç –≥–∏–±–∫–æ—Å—Ç—å, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç:

- –∏–Ω–¥–µ–∫—Å –ø–æ –ø–æ–ª—è–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏;
    
- –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏ —Å –±–æ–ª—å—à–∏–º–∏ –Ω–∞–±–æ—Ä–∞–º–∏ (RAM —Ä–∞—Å—Ç—ë—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –æ–∫–Ω—É).
    

---

### 10. –ì–¥–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

‚úÖ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã (–∫—É–º—É–ª—è—Ç–∏–≤—ã, –¥–æ–ª–∏, —Ä–µ–π—Ç–∏–Ω–≥–∏)  
‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–∞–∑–Ω–∏—Ü—ã, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, —Ç—Ä–µ–Ω–¥—ã)  
‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
‚úÖ –ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã –±–µ–∑ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤

---

### üí° –í –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–µ

> **–û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** –¥–∞—é—Ç SQL ‚Äú–ø–∞–º—è—Ç—å‚Äù:  
> –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∏—Ç —Å–æ—Å–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî  
> –∏ –º–æ–∂–µ—Ç –ø–æ—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—É, —Ä–∞–∑–Ω–∏—Ü—É –∏–ª–∏ –ø–æ–∑–∏—Ü–∏—é,  
> –Ω–µ —Ç–µ—Ä—è—è —Å–∞–º—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö.