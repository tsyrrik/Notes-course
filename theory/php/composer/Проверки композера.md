# Composer Checks в CI/CD

## Оглавление

- [Цели](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#%D1%86%D0%B5%D0%BB%D0%B8)
    
- [Быстрый старт](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#%D0%B1%D1%8B%D1%81%D1%82%D1%80%D1%8B%D0%B9-%D1%81%D1%82%D0%B0%D1%80%D1%82)
    
- [Проверки по пунктам](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B8-%D0%BF%D0%BE-%D0%BF%D1%83%D0%BD%D0%BA%D1%82%D0%B0%D0%BC)
    
    - [composer validate](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#composer-validate)
        
    - [composer check-platform-reqs](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#composer-check-platform-reqs)
        
    - [composer outdated](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#composer-outdated)
        
    - [composer normalize](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#composer-normalize)
        
    - [composer unused](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#composer-unused)
        
    - [composer-require-checker](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#composer-require-checker)
        
    - [Смок без dev-зависимостей](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#%D1%81%D0%BC%D0%BE%D0%BA-%D0%B1%D0%B5%D0%B7-dev-%D0%B7%D0%B0%D0%B2%D0%B8%D1%81%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B5%D0%B9)
        
- [GitHub Actions: готовый workflow](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#github-actions-%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D1%8B%D0%B9-workflow)
    
- [GitLab CI: готовый pipeline](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#gitlab-ci-%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D1%8B%D0%B9-pipeline)
    
- [Примечания и практические советы](https://chatgpt.com/c/68fc84bd-fb50-832b-8f41-d33e06c63bb6#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%87%D0%B0%D0%BD%D0%B8%D1%8F-%D0%B8-%D0%BF%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5-%D1%81%D0%BE%D0%B2%D0%B5%D1%82%D1%8B)
    

---

## Цели

1. Валидность `composer.json`.
    
2. Совместимость окружения (PHP и расширения).
    
3. Контроль обновлений зависимостей.
    
4. Единый стиль манифеста (`normalize`).
    
5. Выявление неиспользуемых и недекларированных зависимостей.
    
6. Гарантия: приложение запускается **без** dev-зависимостей.
    

---

## Быстрый старт

```bash
# базовая установка
composer install --no-interaction --no-progress

# 1) валидность
composer validate --strict

# 2) соответствие платформе (PHP и ext-*)
composer check-platform-reqs

# 3) устаревшие зависимости (строгий режим, только мажорные)
composer outdated --strict --major-only

# 4) нормализация composer.json (требуется ergebnis/composer-normalize)
composer normalize --dry-run --diff

# 5) неиспользуемые зависимости (требуется icanhazstring/composer-unused)
composer unused --no-interaction

# 6) проверка недекларированных зависимостей (требуется maglnet/composer-require-checker)
composer-require-checker check

# 7) смок без dev-зависимостей
rm -rf vendor
composer install --no-dev --no-interaction --no-progress --optimize-autoloader
# симфони
[ -f bin/console ] && php -d detect_unicode=0 bin/console -V && php bin/console about
# ларавел
[ -f artisan ] && php artisan --version
```

---

## Проверки по пунктам

### composer validate

Проверяет синтаксис и схему `composer.json`.

```bash
composer validate --strict
```

- `--strict` заставляет вернуть ненулевой код при предупреждениях.
    

---

### composer check-platform-reqs

Сверяет `require`/`require-dev` с текущей платформой: версия PHP и наличие `ext-*`.

```bash
composer check-platform-reqs
```

- Ловит ситуации “на CI есть ext-intl, а в проде нет”.
    

---

### composer outdated

Показывает пакеты, для которых есть новые версии. В CI чаще используют строгий режим и фильтры:

```bash
# падать, если обнаружены доступные обновления мажорной версии (только прямые зависимости)
composer outdated --strict --major-only --direct
```

> Примечание про сортировку по возрасту релиза: в самом Composer **нет** флага `--sort-by-age`.  
> Если нужно, собирай JSON и сортируй скриптом, обогащая данными из Packagist API (не обязательно для CI).

---

### composer normalize

Единообразное форматирование `composer.json`. Требуется плагин:

```bash
composer require --dev ergebnis/composer-normalize
composer normalize --dry-run --diff
```

- В CI используем `--dry-run --diff`, чтобы не переписывать файл, а лишь завалить билд, если он “грязный”.
    

---

### composer unused

Ищет зависимости, которые не используются твоим кодом. Требуется плагин:

```bash
composer require --dev icanhazstring/composer-unused
composer unused --no-interaction
```

- Полезно чистить мусор из `require`.
    

---

### composer-require-checker

Проверяет, что **все используемые классы/функции** реально объявлены в `require` (а не подтянулись случайно через транзитивные зависимости).

```bash
composer require --dev maglnet/composer-require-checker
composer-require-checker check
```

- Ловит “скрытые” зависимости, которых нет в `composer.json`.
    

---

### Смок без dev-зависимостей

Гарантирует, что приложение живёт без `require-dev`.

```bash
rm -rf vendor
composer install --no-dev --no-interaction --no-progress --optimize-autoloader

# Symfony
[ -f bin/console ] && php bin/console -V && php bin/console about

# Laravel
[ -f artisan ] && php artisan --version
```

- Для приложений с CLI-командами добавь простую smoke-команду (например, `app:health-check`).
    

---

## Примечания и практические советы

- `composer outdated`:
    
    - `--strict` возвращает ненулевой код, если есть устаревшие пакеты по заданным фильтрам.
        
    - Флагов сортировки по возрасту релиза нет. Если нужен приоритезационный отчёт, генерируй JSON и обрабатывай своим скриптом.
        
- `composer normalize` лучше закрепить в pre-commit hook, чтобы CI не падал из-за форматирования.
    
- `composer-unused` иногда даёт ложные срабатывания при динамической загрузке классов; поддерживай `.composer-unused.php` конфиг-исключения.
    
- `composer-require-checker` потребует корректной секции `autoload` и, возможно, файла конфигурации с разрешёнными платформенными символами (расширения PHP).
    
- Для стабильности в Docker укажи `config.platform` в `composer.json`, чтобы локальная версия PHP не влияла на разрешение зависимостей в CI.
    

