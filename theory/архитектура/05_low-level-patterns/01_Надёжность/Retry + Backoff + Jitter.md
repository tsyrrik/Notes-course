## Retry + Backoff + Jitter

### Какую боль лечит
Сети и внешние сервисы падают кратковременно: 500, timeout, connection reset. Повтор запроса повышает шанс успеха, но без задержек и джиттера можно устроить сам себе DDoS и добить зависимый сервис.

### Когда применять
- Запросы к нестабильным или перегруженным сервисам/БД/очередям.
- Чтение или идемпотентная запись (повтор не должен ломать данные).
- В фоновых джобах и интеграциях, где пару секунд задержки допустимы.

Когда **не** применять: операции без идемпотентности (двойное списание), команды запуска “сайд-эффектов” без дедупликации, долгие задачи, где лучше поставить в очередь.

### Поток
1) Выполнить запрос.
2) Если ошибка/timeout — подождать `backoff` (увеличивается с попытками).
3) При каждом ожидании добавить `jitter` (рандом, чтобы не бить синхронно).
4) Ограничить максимальное число попыток и общий таймаут.

### Быстрый пример (PHP, HTTP-запрос)
```php
$maxAttempts = 4;
$base = 0.2; // сек
$cap = 5;    // макс пауза

for ($attempt = 1; $attempt <= $maxAttempts; $attempt++) {
    $res = @file_get_contents('https://payments/api');
    if ($res !== false) {
        break; // ок
    }

    if ($attempt === $maxAttempts) {
        throw new RuntimeException('payments unavailable');
    }

    // exponential backoff c jitter (full jitter)
    $sleep = min($cap, $base * (2 ** ($attempt - 1)));
    $sleep = $sleep * mt_rand() / mt_getrandmax(); // 0..sleep
    usleep((int)($sleep * 1_000_000));
}
```
Во фреймворках часто есть готовые ретраи (Guzzle `RetryMiddleware`, Symfony HttpClient `retry_failed`, Laravel `retry()` хелпер) — включай там же джиттер.

### Настройки, о которых не забыть
- Список ошибок, которые имеет смысл ретраить: сетевые таймауты, 429/503/500 без тела, закрытое соединение. Не ретрить 4xx вроде 400/401/403/404.
- Лимит попыток и общий срок (overall timeout), чтобы не зависать бесконечно.
- Backoff стратегия: exponential c cap (например 0.1, 0.2, 0.4, 0.8, 1.6… макс 5s).
- Jitter: разбрасываем задержку, чтобы куча клиентов не стреляла одновременно.
- Idempotency: ключи/версионирование, чтобы повтор не создал дубликаты.

### Типичные грабли
- Повторяем без джиттера — все клиенты синхронно бьют в пике после падения.
- Нет ограничения общего времени — блокируем пул потоков/воркеров.
- Ретрим бизнес-ошибки (валидность, авторизация) и только загружаем систему.
- Ретрим побочные эффекты без идемпотентности — получаем двойные списания.
- Нет метрик по попыткам — не видим, что сервис рядом начал деградировать.

### Как проверять в проде
- Метрики: количество попыток на запрос, доля ретраев, успех после повторов, средняя/макс задержка из-за backoff.
- Алерты: скачок доли ретраев или переход в кап (cap reached) — сигнал деградации соседнего сервиса.
- Логи/трейсы: добавляй мета `attempt`, `sleep_ms`, `error_type` и протаскивай `trace_id` через повтор.***
