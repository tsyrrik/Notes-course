
**Saga** — это паттерн, который помогает **координировать несколько распределённых операций**,  
где нет единой транзакции, но нужна **гарантированная согласованность**.

---

### 1. Проблема

В микросервисах нельзя просто сделать `BEGIN TRANSACTION` и `COMMIT` через все сервисы.  
Каждый живёт своей жизнью, в своей базе.

Пример:

1. Сервис заказов создаёт заказ.
    
2. Сервис оплаты списывает деньги.
    
3. Сервис доставки резервирует место на складе.
    

Если шаг 3 падает — откатывать надо всё вручную: вернуть оплату, отменить заказ.  
Вот это и делает **Saga**.

---

### 2. Что такое Saga

**Saga** — это цепочка **локальных транзакций**,  
где каждая операция имеет **компенсирующую (откатную)**.

То есть, если один шаг не удался — Saga запускает обратные действия,  
чтобы вернуть систему в согласованное состояние.

---

### 3. Два способа реализации

#### **1. Choreography (хореография)**

Каждый сервис **сам реагирует на события** и запускает следующее.

```text
OrderService → publish OrderCreated
    ↓
PaymentService → on(OrderCreated) → publish PaymentCompleted
    ↓
ShippingService → on(PaymentCompleted)
```

Если что-то идёт не так, публикуется событие вроде `PaymentFailed`,  
и другие сервисы сами решают, как компенсировать.

✅ Просто.  
❌ Легко скатиться в “event spaghetti” — сложно понять, кто за что отвечает.

---

#### **2. Orchestration (оркестрация)**

Есть **центральный координирующий сервис (Saga Orchestrator)**,  
который управляет всем процессом.

```php
class OrderSaga
{
    public function execute(Order $order): void
    {
        $this->payment->charge($order);
        $this->shipping->reserve($order);
        $this->notifier->sendConfirmation($order);
    }

    public function compensate(Order $order): void
    {
        $this->shipping->cancelReservation($order);
        $this->payment->refund($order);
    }
}
```

✅ Централизовано и наглядно.  
❌ Координатор становится точкой концентрации логики и ошибок.

---

### 4. Компенсационные действия

Каждый шаг должен уметь **отменить свои изменения**, если процесс не завершился.

|Шаг|Команда|Компенсация|
|---|---|---|
|Создать заказ|`CreateOrder`|`CancelOrder`|
|Списать оплату|`ChargePayment`|`RefundPayment`|
|Резервировать доставку|`ReserveShipment`|`CancelShipment`|

---

### 5. Saga vs Temporal

- **Saga** — это _паттерн координации транзакций_ (логическая идея).
    
- **Temporal** — это _технология реализации_ подобных паттернов (оркестрация, retry, rollback).  
    Temporal workflows очень часто реализуют Sagas под капотом.
    

---

### 6. Пример в духе PHP

```php
class OrderSaga
{
    public function __construct(
        private PaymentGateway $payment,
        private ShippingService $shipping,
    ) {}

    public function handle(Order $order): void
    {
        try {
            $this->payment->charge($order);
            $this->shipping->reserve($order);
        } catch (\Throwable $e) {
            $this->shipping->cancel($order);
            $this->payment->refund($order);
            throw $e;
        }
    }
}
```

Saga не делает весь процесс атомарным,  
но **делает его согласованным**: система либо полностью завершена, либо компенсирована.

---

### 7. Когда применять

- Микросервисы с независимыми базами.
    
- Финансовые или платёжные процессы.
    
- Заказы, билеты, бронирования, подписки.
    
- Всё, где rollback между сервисами невозможен напрямую.
    

---

### 8. В одной фразе

> Saga — это транзакция, растянутая во времени и между сервисами,  
> где у каждого шага есть план “отката назад”.

[[Temporal]]
[[Распределённые транзакции]]
